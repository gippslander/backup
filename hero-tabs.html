<style>
    /* --- DASHBOARD WRAPPER --- */
    .browse-section { 
        max-width: 1100px; 
        margin: 50px auto 40px auto; 
        padding: 0 20px; 
        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; 
        clear: both;
        box-sizing: border-box;
        overflow-x: hidden; /* Prevent horizontal scroll on wrapper */
    }

    /* --- TABS --- */
    .browse-tabs { display: flex; justify-content: flex-start; flex-wrap: wrap; gap: 20px; margin-bottom: 25px; border-bottom: 1px solid #e5e7eb; }
    
    .browse-tab { 
        padding: 0 5px 12px; font-size: 0.95rem; font-weight: 600; color: #6b7280; cursor: pointer; 
        background: none; border: none; position: relative; transition: color 0.2s; outline: none; 
        -webkit-tap-highlight-color: transparent; display: flex; align-items: center; 
    }
    .browse-tab:focus { outline: none; }
    .browse-tab:hover { color: #111827; }
    .browse-tab.active { color: #4CAF50; }
    .browse-tab.active::after { content: ''; position: absolute; bottom: -1px; left: 0; width: 100%; height: 2px; background: #4CAF50; }
    .browse-tab.hidden { display: none !important; }

    /* COUNT BADGES */
    .tab-count { 
        font-size: 0.75rem; font-weight: 700; background: #f3f4f6; color: #6b7280; 
        padding: 2px 8px; border-radius: 20px; margin-left: 6px; transition: all 0.2s; 
    }
    .browse-tab.active .tab-count { background: #4CAF50; color: white; }

    /* CONTENT AREAS */
    .tab-content { display: none; animation: dashboardFadeIn 0.3s ease; }
    .tab-content.active { display: grid; }
    
    @keyframes dashboardFadeIn { from { opacity: 0; transform: translateY(3px); } to { opacity: 1; transform: translateY(0); } }

    /* GRID LAYOUT */
    .sector-grid { grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 12px; width: 100%; }
    
    /* CARD STYLES */
    .sector-card { 
        display: flex; align-items: center; gap: 15px; text-decoration: none !important; 
        background: white; border-radius: 12px; border: 1px solid #e5e7eb; padding: 12px 15px; 
        transition: all 0.2s ease; min-height: 70px; color: inherit; box-shadow: none; position: relative;
        cursor: pointer; box-sizing: border-box; width: 100%;
        overflow: hidden; /* CRITICAL FIX: Cuts off anything spilling out */
    }
    .sector-card:hover { border-color: #4CAF50; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }

    /* ICONS & LOGOS */
    .card-icon-bubble { width: 42px; height: 42px; background: #f0fdf4; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: #166534; flex-shrink: 0; overflow: hidden; }
    .card-icon-bubble svg { width: 22px; height: 22px; fill: currentColor; }
    .card-icon-bubble img { width: 100%; height: 100%; object-fit: contain; }

    /* TEXT - WRAPPING FIX */
    .sector-info { display: flex; flex-direction: column; justify-content: center; flex: 1; min-width: 0; }
    
    .sector-title { 
        font-size: 0.95rem; font-weight: 700; color: #111827; margin: 0; line-height: 1.3; 
        /* Allow wrapping to 2 lines instead of forcing 1 line */
        white-space: normal;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    .sector-meta { font-size: 0.75rem; color: #9ca3af; margin-top: 2px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    
    /* PIN BUTTON STYLE */
    .pin-btn {
        background: none; border: none; padding: 5px; cursor: pointer; color: #d1d5db; transition: color 0.2s;
        display: flex; align-items: center; justify-content: center; margin-left: auto; z-index: 10;
        flex-shrink: 0;
    }
    .pin-btn:hover { color: #f59e0b; transform: scale(1.1); }
    .pin-btn.active { color: #f59e0b; }
    .pin-btn svg { width: 18px; height: 18px; fill: currentColor; }

    .manage-card { border: 1px dashed #d1d5db; background: #f9fafb; justify-content: center; color: #4CAF50; font-weight: 600; font-size: 0.9rem; text-align: center; }
    .empty-message { grid-column: 1 / -1; text-align: center; padding: 30px; color: #6b7280; background: #f9fafb; border-radius: 12px; }

    /* MOBILE SAFETY FIXES */
    @media (max-width: 850px) {
        .browse-section { padding: 0 15px; width: 100%; overflow-x: hidden; }
        
        /* Layout relies on .tab-content.active to show */
        .sector-grid { grid-template-columns: 1fr; gap: 10px; width: 100%; }
        
        .browse-tab { font-size: 0.8rem; padding: 5px 8px; margin-bottom: 5px; }
        .browse-tabs { gap: 8px; justify-content: center; margin-bottom: 20px; }
        .sector-card { max-width: 100%; width: 100%; padding: 12px; }
    }
</style>

<div class="browse-section">
    <div class="browse-tabs">
        <button class="browse-tab active" id="btn-sectors" onclick="dashTabs.open('sectors')">Sectors</button>
        <button class="browse-tab" id="btn-locations" onclick="dashTabs.open('locations')">Locations</button>
        <button class="browse-tab" id="btn-courses" onclick="dashTabs.open('courses')">Short courses</button>
        <button class="browse-tab" id="btn-saved-searches" onclick="dashTabs.open('saved-searches')">Saved searches</button>
        <button class="browse-tab" id="btn-saved-jobs" onclick="dashTabs.open('saved-jobs')">Saved jobs</button>
    </div>

    <div id="tab-sectors" class="tab-content sector-grid active">
        <a href="/jobs/administration-and-support" class="sector-card"><div class="card-icon-bubble"><svg viewBox="0 0 24 24"><path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg></div><div class="sector-info"><span class="sector-title">Admin & support</span></div></a>
        <a href="/jobs/community-and-social-services" class="sector-card"><div class="card-icon-bubble"><svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg></div><div class="sector-info"><span class="sector-title">Community & social</span></div></a>
        <a href="/jobs/construction-and-trades" class="sector-card"><div class="card-icon-bubble"><svg viewBox="0 0 24 24"><path d="M22.7 19l-9.1-9.1c.9-2.3.4-5-1.5-6.9-2-2-5-2.4-7.4-1.3L9 6 6 9 1.6 4.7C.4 7.1.9 10.1 2.9 12.1c1.9 1.9 4.6 2.4 6.9 1.5l9.1 9.1c.4.4 1 .4 1.4 0l2.3-2.3c.5-.4.5-1.1.1-1.4z"/></svg></div><div class="sector-info"><span class="sector-title">Trades</span></div></a>
        <a href="/jobs/education-and-training" class="sector-card"><div class="card-icon-bubble"><svg viewBox="0 0 24 24"><path d="M12 3L1 9l11 6 9-4.91V17h2V9L12 3zm6.5 4.5L12 11.09 5.5 7.5 12 3.91l6.5 3.59zM3.5 18.28l6.5 3.61v-3.11l-6.5-3.61v3.11zM14 18.79v3.1l6.5-3.61v-3.11l-6.5 3.62z"/></svg></div><div class="sector-info"><span class="sector-title">Education</span></div></a>
        <a href="/jobs/maintenance-and-cleaning" class="sector-card"><div class="card-icon-bubble"><svg viewBox="0 0 24 24"><path d="M19.36 2.72L21.28 4.64L13.76 12.16L14.72 13.12L12.16 15.68L9.6 13.12L10.56 12.16L3.04 4.64L4.96 2.72L12.16 9.92L19.36 2.72M12 16L15.5 21.5H8.5L12 16Z"/></svg></div><div class="sector-info"><span class="sector-title">Maintenance</span></div></a>
        <a href="/jobs/healthcare-and-medical" class="sector-card"><div class="card-icon-bubble"><svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-1.9.9-1.9 2L3 19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-1 11h-4v4h-4v-4H6v-4h4V6h4v4h4v4z"/></svg></div><div class="sector-info"><span class="sector-title">Healthcare</span></div></a>
        <a href="/jobs/retail-and-hospitality" class="sector-card"><div class="card-icon-bubble"><svg viewBox="0 0 24 24"><path d="M20 4H4v2h16V4zm1 10v-2l-1-5H4l-1 5v2h1v6h10v-6h4v6h2v-6h1zm-9 4H6v-4h6v4z"/></svg></div><div class="sector-info"><span class="sector-title">Retail & hospitality</span></div></a>
        
        <a href="/jobs" class="sector-card manage-card">View all &rarr;</a>
    </div>

    <div id="tab-locations" class="tab-content sector-grid"></div>
    <div id="tab-courses" class="tab-content sector-grid"></div>
    <div id="tab-saved-searches" class="tab-content sector-grid"></div>
    <div id="tab-saved-jobs" class="tab-content sector-grid"></div>
</div>

<script>
var dashTabs = (function() {
    const cb = new Date().getTime();
    const LOC_URL = `https://cdn.jsdelivr.net/gh/gippslander/assets@main/locations.json?v=${cb}`;
    const SEARCH_KEY = 'gippslander_saved_searches';
    let locationsData = [];

    function cleanTitle(title) { if (!title) return "Saved item"; return title.split(/[|]| - /)[0].trim(); }
    function getStored(key) { try { const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : []; } catch(e) { return []; } }

    async function loadLocations() {
        try { 
            const res = await fetch(LOC_URL);
            locationsData = await res.json();
        } catch (e) { console.error("Locs fail"); }
        updateBadges();
    }

    function updateBadges() {
        const searches = getStored(SEARCH_KEY);
        const jobs = getStored('gippslander_saved_jobs');
        
        const sBtn = document.getElementById('btn-saved-searches');
        if (searches.length === 0) sBtn?.classList.add('hidden');
        else if (sBtn) { sBtn.classList.remove('hidden'); sBtn.innerHTML = `Saved searches <span class="tab-count">${searches.length}</span>`; }
        
        const jBtn = document.getElementById('btn-saved-jobs');
        if (jobs.length === 0) jBtn?.classList.add('hidden');
        else if (jBtn) { jBtn.classList.remove('hidden'); jBtn.innerHTML = `Saved jobs <span class="tab-count">${jobs.length}</span>`; }
    }

    async function open(tabName) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.browse-tab').forEach(el => el.classList.remove('active'));
        
        document.getElementById('tab-' + tabName)?.classList.add('active');
        document.getElementById('btn-' + tabName)?.classList.add('active');
        
        if(tabName === 'locations') await renderLocations();
        if(tabName === 'courses') renderCourses();
        if(tabName === 'saved-searches') renderSaved('searches');
        if(tabName === 'saved-jobs') renderSaved('jobs');
    }

    function togglePin(url) {
        let items = getStored(SEARCH_KEY);
        const index = items.findIndex(i => i.url === url);
        if (index > -1) {
            items[index].isPinned = !items[index].isPinned;
            localStorage.setItem(SEARCH_KEY, JSON.stringify(items));
            renderSaved('searches'); 
            updateBadges();
        }
    }

    async function renderLocations() {
        const c = document.getElementById('tab-locations');
        if (locationsData.length === 0) {
            c.innerHTML = '<div class="empty-message">Loading locations...</div>';
            await loadLocations();
        }
        if (locationsData.length === 0) { c.innerHTML = '<div class="empty-message">Could not load locations.</div>'; return; }
        
        const top = locationsData.sort((a,b) => (b.priority || 0) - (a.priority || 0)).slice(0, 7);
        let html = top.map(loc => `<a href="${loc.full_name ? '/jobs/in-' + loc.full_name.toLowerCase().replace(/,/g, '').replace(/\s+/g, '-') : '/jobs?location=' + encodeURIComponent(loc.label)}" class="sector-card"><div class="card-icon-bubble"><svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg></div><div class="sector-info"><span class="sector-title">${loc.label}</span></div></a>`).join('');
        html += `<a href="/locations" class="sector-card manage-card">View all locations &rarr;</a>`;
        c.innerHTML = html;
    }

    async function renderCourses() {
        const c = document.getElementById('tab-courses');
        if(!c || c.children.length > 0) return;
        c.innerHTML = `<div class="empty-message">Loading courses...</div>`;
        const query = `{ courses { courseTitle logo active featured provider { name } url } }`;
        try {
            const res = await fetch("https://api.baseql.com/airtable/graphql/appnoS15udCLKToYs", { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ query }) });
            const result = await res.json();
            const feat = result.data.courses.filter(i => (i.active === true || String(i.active) === "true") && (i.featured === true || String(i.featured) === "true")).slice(0, 7);
            let html = feat.map(i => {
                const logo = (i.logo && i.logo[0]) ? (typeof i.logo[0] === 'string' ? i.logo[0] : i.logo[0].url) : "";
                return `<a href="${i.url || '#'}" target="_blank" class="sector-card"><div class="card-icon-bubble">${logo ? '<img src="'+logo+'">' : '<svg viewBox="0 0 24 24"><path d="M12 3L1 9l11 6 9-4.91V17h2V9L12 3z"/></svg>'}</div><div class="sector-info"><span class="sector-title">${i.courseTitle}</span><span class="sector-meta">${i.provider[0].name}</span></div></a>`;
            }).join('');
            html += `<a href="/courses" class="sector-card manage-card">View all courses &rarr;</a>`;
            c.innerHTML = html;
        } catch (e) { c.innerHTML = `<div class="empty-message">Error loading courses.</div>`; }
    }

    function renderSaved(type) {
        const c = document.getElementById('tab-saved-' + type);
        let items = getStored('gippslander_saved_' + type);
        
        if (items.length === 0) { c.innerHTML = `<div class="empty-message">No saved ${type} yet.</div>`; return; }

        if (type === 'searches') {
            items.sort((a, b) => (b.isPinned ? 1 : 0) - (a.isPinned ? 1 : 0) || (b.lastUsed || 0) - (a.lastUsed || 0));
        } else {
            items.sort((a, b) => (b.lastUsed || 0) - (a.lastUsed || 0));
        }
        
        items = items.slice(0, 8);

        let html = items.map(i => {
            const isPinned = i.isPinned === true;
            if (type === 'searches') {
                return `
                <div class="sector-card" onclick="window.location.href='${i.url}'">
                    <div class="card-icon-bubble">
                        <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                    </div>
                    <div class="sector-info">
                        <span class="sector-title">${cleanTitle(i.title)}</span>
                        <span class="sector-meta">${i.lastUsed ? new Date(i.lastUsed).toLocaleDateString('en-AU', {month:'short', day:'numeric'}) : 'Recently'}</span>
                    </div>
                    <button class="pin-btn ${isPinned ? 'active' : ''}" onclick="event.stopPropagation(); dashTabs.togglePin('${i.url}')">
                        <svg viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                    </button>
                </div>`;
            } else {
                return `
                <a href="${i.url}" class="sector-card">
                    <div class="card-icon-bubble">
                        <svg viewBox="0 0 24 24"><path d="M20 6h-4V4c0-1.11-.89-2-2-2h-4c-1.11 0-2 .89-2 2v2H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-6 0h-4V4h4v2z"/></svg>
                    </div>
                    <div class="sector-info">
                        <span class="sector-title">${cleanTitle(i.title)}</span>
                        <span class="sector-meta">${i.lastUsed ? new Date(i.lastUsed).toLocaleDateString('en-AU', {month:'short', day:'numeric'}) : 'Recently'}</span>
                    </div>
                </a>`;
            }
        }).join('');
        
        html += `<a href="/my?tab=${type === 'searches' ? 'searches' : 'jobs'}" class="sector-card manage-card">Manage all &rarr;</a>`;
        c.innerHTML = html;
    }

    loadLocations();
    return { open, togglePin };
})();
</script>
